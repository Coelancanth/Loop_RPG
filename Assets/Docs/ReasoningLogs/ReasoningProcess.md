# PathInitializer 矩形变异法实现记录 - [2024-01-09]

## 需求分析

### 背景与目标
- **目的：** 实现一个可靠的闭环路径生成算法
- **原因：** 之前的随机生成方法难以保证在有限尝试内生成有效闭环

### 功能需求
**FR1: 基础矩形路径生成**
- **输入：** 期望的路径长度
- **输出：** 最接近目标长度的矩形路径

**FR2: 路径变异**
- **输入：** 基础矩形路径
- **输出：** 经过变异但仍保持闭环的路径

**FR3: 变异规则控制**
- **输入：** 变异参数（强度、次数等）
- **输出：** 符合规则的变异结果

### 非功能需求
1. **可靠性：** 100%保证生成闭环路径
2. **性能：** 生成时间应在50ms内完成
3. **可控性：** 变异程度可配置
4. **随机性：** 基于种子的可重现随机

### 实现计划

#### 1. 基础矩形生成器
```csharp
public class RectanglePathGenerator
{
    // 根据目标长度计算最佳矩形尺寸
    public (int width, int height) CalculateRectangleSize(int targetLength);
    
    // 生成基础矩形路径
    public List<Vector2Int> GenerateBasePath(int width, int height);
}
```

#### 2. 路径变异器
```csharp
public class PathMutator
{
    // 应用单次变异
    public bool TryMutate(List<Vector2Int> path, float intensity);
    
    // 验证变异是否有效
    private bool ValidateMutation(List<Vector2Int> path);
}
```

### 变异规则设计
1. **基本变异类型：**
   - 内凹变异：将直线段向内凹陷
   - 外凸变异：将直线段向外突出
   - 局部重排：重新排列局部路径段

2. **变异约束：**
   - 保持闭环性
   - 禁止自交叉
   - 保持最小间距
   - 限制变异范围

3. **变异算法：**
   ```plaintext
   1. 选择矩形边上的一个点 P
   2. 计算可能的变异方向 D
   3. 如果变异不会导致：
      - 路径自交叉
      - 破坏闭环
      - 违反最小间距
   4. 则应用变异
   5. 重复直到达到期望的变异程度
   ```

### 测试策略
1. **单元测试**
   - 矩形生成测试
   - 变异规则验证
   - 闭环性检查

2. **属性测试**
   - 不同长度测试
   - 不同种子测试
   - 变异强度测试

3. **性能测试**
   - 生成时间测试
   - 内存使用测试

### 下一步计划
1. 实现基础矩形生成器
2. 实现变异规则系统
3. 添加变异参数配置
4. 优化变异算法
5. 实现可视化调试工具

### 依赖关系
- Unity 2022.3
- RandomManager（用于可重现随机）
- 自定义数学工具库（用于路径计算）
